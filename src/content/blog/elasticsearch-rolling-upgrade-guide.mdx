---
title: "Elasticsearch 9.0+ æ»¾å‹•å‡ç´šæ‰‹å†Šï¼šSRE çš„é›¶åœæ©Ÿå¯¦æˆ°æŒ‡å—"
description: "å‡ç´š ES æœ€æ€• Split-Brain æˆ–è³‡æ–™æ¯€æã€‚æœ¬æ–‡ä¾ç…§ Data Tiers æ¶æ§‹ï¼Œæ‹†è§£ Rolling Upgrade çš„æ¨™æº– SOPï¼Œå¾ Frozen Tier åˆ° Master Nodeï¼Œç¢ºä¿æœå‹™ä¸ä¸­æ–·ã€‚"
pubDate: "2026-02-02"
tags: ["Elasticsearch", "Upgrade", "SRE", "DevOps", "Maintenance"]
slug: "elasticsearch-rolling-upgrade-guide"
---

## ç‚ºä»€éº¼è¦ Rolling Upgradeï¼Ÿ

åœ¨ Production ç’°å¢ƒï¼Œæˆ‘å€‘è¿½æ±‚çš„æ˜¯ **Zero Downtime (é›¶åœæ©Ÿ)**ã€‚
Rolling Upgrade å…è¨±æˆ‘å€‘ä¸€æ¬¡é‡å•Ÿä¸€å€‹ç¯€é»ï¼Œæ•´å€‹ Cluster ä¾ç„¶ä¿æŒæœå‹™ã€‚

ä½†åœ¨ 9.0+ çš„å‡ç´šä¸­ï¼Œæœ‰ä¸€å€‹ç‰©ç†é™åˆ¶å¿…é ˆè¨˜ä½ï¼š
> **ã€Œæ–°ç‰ˆç¯€é»çš„ Shard ç„¡æ³•è¤‡è£½å›èˆŠç‰ˆç¯€é»ã€‚ã€**

é€™æ„å‘³è‘—åœ¨å‡ç´šéç¨‹ä¸­ï¼Œå¦‚æœä¸€å€‹æ–°ç‰ˆç¯€é»æ›äº†ï¼Œå®ƒçš„è³‡æ–™ç„¡æ³•è½‰ç§»åˆ°é‚„æ²’å‡ç´šçš„èˆŠç¯€é»ä¸Šã€‚æ‰€ä»¥ï¼Œ**ã€Œé †åºã€** æ±ºå®šäº†ç”Ÿæ­»ã€‚

---

## ç¬¬ä¸€éšæ®µï¼šå‡ç´šå‰çš„æº–å‚™ (Pre-flight Check)

åœ¨å‹•æ‰‹ä¹‹å‰ï¼Œè«‹ç¢ºèªä»¥ä¸‹äº‹é …ï¼š

1.  **å‚™ä»½ (Snapshot)ï¼š** é€™æ˜¯ SRE çš„ä¿å‘½ç¬¦ã€‚ä¸è¦ç›¸ä¿¡è‡ªå·±çš„é‹æ°£ï¼ŒåŸ·è¡Œä¸€æ¬¡å®Œæ•´çš„ Snapshotã€‚
2.  **æª¢æŸ¥ Deprecationsï¼š** ä½¿ç”¨ Kibana çš„ Upgrade Assistant ç¢ºèªæœ‰æ²’æœ‰å³å°‡è¢«ç§»é™¤çš„è¨­å®šã€‚
3.  **è¦åŠƒé †åº (The Order)ï¼š** é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ã€‚

### ğŸš€ é»ƒé‡‘å‡ç´šé †åº (The Upgrade Order)

å®˜æ–¹å»ºè­°åš´æ ¼éµå®ˆä»¥ä¸‹é †åºï¼Œç¢ºä¿ ILM (ç”Ÿå‘½é€±æœŸç®¡ç†) èƒ½æ­£å¸¸é‹ä½œï¼Œä¸” Master æœ€å¾Œå‡ç´šä»¥ç¶­æŒè…¦éƒ¨ç©©å®šã€‚

1.  **Frozen Tier** (æœ€ä¸é‡è¦ï¼Œå…ˆç•¶ç™½è€é¼ )
2.  **Cold Tier**
3.  **Warm Tier**
4.  **Hot Tier** (å¯«å…¥ç†±å€)
5.  **Coordinating / Ingest / ML** (ç„¡è³‡æ–™ç¯€é»)
6.  **Master Eligible Nodes** (æœ€å¾Œå‡ç´šå¤§è…¦)

---

## ç¬¬äºŒéšæ®µï¼šSOP å¾ªç’° (æ¯å° Node åšä¸€æ¬¡)

è«‹é‡å°æ¯ä¸€å°æ©Ÿå™¨ï¼Œä¾åºåŸ·è¡Œä»¥ä¸‹ 8 å€‹æ­¥é©Ÿã€‚**åš´ç¦åŒæ™‚é‡å•Ÿå¤šå°æ©Ÿå™¨ã€‚**

### Step 1: æš«åœ Shard åˆ†é… (Disable Allocation)
æˆ‘å€‘ä¸å¸Œæœ›å› ç‚ºé‡å•Ÿä¸€å°æ©Ÿå™¨ï¼ŒES å°±é–‹å§‹ç˜‹ç‹‚æ¬é‹å¹¾ TB çš„è³‡æ–™ã€‚æˆ‘å€‘å…ˆå« Cluster ã€Œå†·éœã€ï¼Œä¸è¦å› ç‚ºçŸ­æš«çš„é›¢ç·šå°±è§¸ç™¼ Rebalanceã€‚

```json
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "primaries"
  }
}
```
è¨­å®šç‚ºÂ `primaries`Â ä»£è¡¨ï¼šåªå…è¨±ä¸»åˆ†ç‰‡åˆ†é…ï¼Œä½†ä¸å…è¨±å‰¯æœ¬æ¬é·ã€‚
### Step 2: æš«åœ ML Jobs (å¦‚æœ‰)

å¦‚æœä½ æœ‰è·‘ Machine Learningï¼Œå…ˆæš«åœå®ƒå€‘ï¼Œé¿å…å‡ç´šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚
```bash
POST _ml/set_upgrade_mode?enabled=true
```
### Step 3: åŸ·è¡Œ Flush (é¸ç”¨ä½†æ¨è–¦)

é€™å¯ä»¥æŠŠ Memory Buffer çš„è³‡æ–™å¯«å…¥ Diskï¼ŒåŠ å¿«é‡å•Ÿå¾Œçš„ Recovery é€Ÿåº¦ã€‚
```
POST /_flush
```
### Step 4: åœæ­¢ä¸¦å‡ç´šç¯€é» (RPM ç¯„ä¾‹)
é€™æ˜¯çœŸæ­£å‹•åˆ€çš„æ™‚å€™ã€‚
```bash
# 1. åœæ­¢æœå‹™
sudo systemctl stop elasticsearch

# 2. ä½¿ç”¨ RPM å‡ç´š (è¨­å®šæª”æœƒè¢«ä¿ç•™ï¼Œæˆ–æ˜¯ç”¢ç”Ÿ .rpmnew)
sudo dnf update elasticsearch

# 3. å‡ç´š Plugins (å¦‚æœæœ‰çš„è©±ï¼Œé€™æ­¥å¸¸è¢«å¿˜è¨˜!)
sudo /usr/share/elasticsearch/bin/elasticsearch-plugin install --batch analysis-icu
```
**SRE é—œéµæª¢æŸ¥ï¼š**Â æª¢æŸ¥Â `/etc/elasticsearch/elasticsearch.yml`ã€‚ åœ¨ Rolling Upgrade ä¸­ï¼Œ**`cluster.initial_master_nodes`Â å¿…é ˆè¢«è¨»è§£æ‰æˆ–ç§»é™¤**ã€‚å› ç‚ºé€™æ˜¯åŠ å…¥ç¾æœ‰ Clusterï¼Œä¸æ˜¯å»ºç«‹æ–° Clusterã€‚
### Step 5: å•Ÿå‹•ç¯€é»
```bash
sudo systemctl start elasticsearch
```
ç¢ºèªå®ƒæœ‰åŠ å…¥ Clusterï¼š
```bash
# æª¢æŸ¥è©² Node çš„ version æ¬„ä½æ˜¯å¦è®Šæˆæ–°ç‰ˆ
GET _cat/nodes?h=ip,name,version&v=ture
```
### Step 6: æ¢å¾© Shard åˆ†é…
ç¯€é»å›ä¾†äº†ï¼Œæˆ‘å€‘è¦å‘Šè¨´ Cluster å¯ä»¥é–‹å§‹æŠŠ Shard æ¬å›é€™å€‹æ–°ç¯€é»äº†ã€‚
```bash
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": null
  }
}
```
### Step 7: ç­‰å¾…ç¶ ç‡ˆ (Wait for Green)
é€™æ˜¯æœ€è€ƒé©—è€å¿ƒçš„æ™‚åˆ»ã€‚**çµ•å°ä¸è¦åœ¨ Status é‚„æ˜¯ Red æˆ– Yellow æ™‚å»å‹•ä¸‹ä¸€å°æ©Ÿå™¨ã€‚**

ç›£æ§ Recovery é€²åº¦ï¼š
```bash
GET /_cluster/health
```
**ğŸ’¡ é»ƒç‡ˆ (Yellow) è­¦å ±ï¼š**Â åœ¨å‡ç´šåˆæœŸï¼Œä½ å¯èƒ½æœƒçœ‹åˆ°ç‹€æ…‹å¡åœ¨Â `Yellow`ã€‚Â _åŸå› ï¼š_Â æ–°ç‰ˆç¯€é»çš„ Shard ä¸èƒ½è¤‡è£½åˆ°èˆŠç‰ˆç¯€é»ã€‚å¦‚æœä½ åªå‡ç´šäº† 1 å°ï¼Œé‚£è©²å°ä¸Šé¢çš„ Primary Shard å°±æ²’æœ‰åœ°æ–¹æ”¾ Replica (å› ç‚ºå…¶ä»–å°é‚„æ˜¯èˆŠç‰ˆ)ã€‚Â _è§£æ³•ï¼š_Â åªè¦ç¢ºèªÂ `init`Â (åˆå§‹åŒ–ä¸­) å’ŒÂ `relo`Â (æ¬é·ä¸­) çš„æ•¸å­—æ˜¯ 0ï¼Œå°±å¯ä»¥ç¹¼çºŒå‡ç´šä¸‹ä¸€å°ã€‚ç­‰åˆ°ç¬¬äºŒå°å‡ç´šå®Œï¼ŒReplica å°±æœƒæœ‰åœ°æ–¹å»äº†ã€‚
### Step 8: é‡è¤‡

å›åˆ° Step 1ï¼Œå°ä¸‹ä¸€å°æ©Ÿå™¨åŸ·è¡ŒåŒæ¨£å‹•ä½œã€‚
## ç¬¬ä¸‰éšæ®µï¼šæ”¶å°¾ (Post-Upgrade)

ç•¶æ‰€æœ‰ç¯€é»ï¼ˆåŒ…å« Masterï¼‰éƒ½å‡ç´šå®Œç•¢ï¼Œä¸” Cluster å‘ˆç¾ç¶ ç‡ˆæ™‚ï¼š

1. **æ¢å¾© ML Jobsï¼š**
```bash
POST _ml/set_upgrade_mode?enabled=false
```

2. **æª¢æŸ¥ Archived Settingsï¼š**Â æœ‰äº›èˆŠç‰ˆè¨­å®šåœ¨ 9.0 å¯èƒ½è¢«ç§»é™¤äº†ï¼Œé€™äº›è¨­å®šæœƒè¢«å°å­˜åœ¨ "archived" namespace ä¸‹ï¼Œå»ºè­°æ¸…ç†æ‰ã€‚

3. **Kibana å‡ç´šï¼š**Â ES å‡ç´šå®Œå¾Œï¼Œåˆ¥å¿˜äº†å‡ç´š Kibanaã€Logstash å’Œ Beats/Agentã€‚

## SRE çš„æœ€å¾Œå®åš€

- **ä¸è¦è·³ç´šï¼š**Â å¦‚æœä½ æ˜¯ 7.xï¼Œè«‹å…ˆå‡åˆ° 7.17ï¼Œå†å‡ 8.xï¼Œæœ€å¾Œæ‰åˆ° 9.xã€‚ä¸è¦å¦„æƒ³å¾ 7.x ç›´æ¥ rpm install 9.0ã€‚
    
- **Log æ˜¯ä½ çš„å¥½æœ‹å‹ï¼š**Â å•Ÿå‹•å¤±æ•—æ™‚ï¼Œç¬¬ä¸€æ™‚é–“çœ‹Â `/var/log/elasticsearch/cluster-name.log`ã€‚é€šå¸¸æ˜¯Â `jvm.options`Â æˆ–Â `elasticsearch.yml`Â çš„æ ¼å¼å•é¡Œã€‚
    