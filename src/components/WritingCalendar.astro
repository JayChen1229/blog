---
// Accept posts as prop to avoid duplicate getCollection call
interface Props {
    posts: any[];
}
const { posts } = Astro.props;

// Helper to generate the last 365 days
const today = new Date();
const oneYearAgo = new Date(today);
oneYearAgo.setFullYear(today.getFullYear() - 1);

const days: Date[] = [];
for (let d = new Date(oneYearAgo); d <= today; d.setDate(d.getDate() + 1)) {
    days.push(new Date(d));
}

// Map post dates to frequency, titles, and slugs
interface PostInfo {
    count: number;
    titles: string[];
    slugs: string[];
}
const postData: Record<string, PostInfo> = posts.reduce(
    (acc: Record<string, PostInfo>, post: any) => {
        const dateStr = post.data.pubDate.toISOString().split("T")[0];
        if (!acc[dateStr]) {
            acc[dateStr] = { count: 0, titles: [], slugs: [] };
        }
        acc[dateStr].count += 1;
        acc[dateStr].titles.push(post.data.title);
        acc[dateStr].slugs.push(post.slug);
        return acc;
    },
    {},
);

// Helper to get color intensity - Blue theme
function getColor(count: number) {
    if (count === 0) return "bg-gray-800";
    if (count === 1) return "bg-blue-700";
    if (count > 1) return "bg-blue-500";
    return "bg-gray-800";
}
---

<div class="my-16 flex justify-center relative" id="calendar-container">
    <div class="w-full max-w-4xl overflow-x-auto pb-4 px-4">
        <div class="min-w-[750px] flex flex-col items-center">
            <h3
                class="text-sm font-semibold text-gray-100 mb-6 text-center tracking-wide"
            >
                寫作日曆
            </h3>
            <div class="grid grid-cols-[auto_1fr] gap-2">
                <div
                    class="grid grid-rows-7 gap-1 text-[10px] text-gray-500 text-right pr-2 leading-[10px] pt-[2px]"
                >
                    <span></span>
                    <span>Mon</span>
                    <span></span>
                    <span>Wed</span>
                    <span></span>
                    <span>Fri</span>
                    <span></span>
                </div>
                <div
                    class="grid grid-flow-col gap-1 grid-rows-7"
                    id="calendar-grid"
                >
                    {
                        days.map((day) => {
                            const dateStr = day.toISOString().split("T")[0];
                            const info = postData[dateStr] || {
                                count: 0,
                                titles: [],
                                slugs: [],
                            };
                            const dateDisplay = day.toLocaleDateString(
                                "zh-TW",
                                {
                                    year: "numeric",
                                    month: "long",
                                    day: "numeric",
                                },
                            );
                            return (
                                <div
                                    class={`w-2.5 h-2.5 rounded-[2px] calendar-cell ${getColor(info.count)} ${info.count > 0 ? "cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all" : ""}`}
                                    data-date={dateDisplay}
                                    data-titles={JSON.stringify(info.titles)}
                                    data-slugs={JSON.stringify(info.slugs)}
                                    data-count={info.count}
                                />
                            );
                        })
                    }
                </div>
            </div>
            <div
                class="flex items-center justify-end w-full max-w-[500px] gap-2 mt-4 text-[10px] text-gray-500"
            >
                <span>Less</span>
                <div class="w-2.5 h-2.5 rounded-[2px] bg-gray-800"></div>
                <div class="w-2.5 h-2.5 rounded-[2px] bg-blue-700"></div>
                <div class="w-2.5 h-2.5 rounded-[2px] bg-blue-500"></div>
                <span>More</span>
            </div>
        </div>
    </div>

    <!-- Article Popover (shown on click) -->
    <div
        id="calendar-popover"
        class="absolute hidden z-50 bg-gray-900/95 backdrop-blur-sm rounded-xl shadow-2xl border border-gray-700/50 px-5 py-4 min-w-[240px] max-w-[320px]"
        style="transform: translate(-50%, -100%); margin-top: -16px;"
    >
        <div
            id="popover-date"
            class="text-xs text-gray-400 mb-3 flex items-center gap-2"
        >
            <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
            </svg>
            <span id="popover-date-text"></span>
        </div>
        <div id="popover-articles" class="space-y-2"></div>
        <div
            class="text-[10px] text-gray-500 mt-3 pt-2 border-t border-gray-700/50 text-center"
        >
            點擊文章標題前往 · 點擊其他處關閉
        </div>
        <!-- Arrow pointer -->
        <div
            class="absolute left-1/2 -translate-x-1/2 -bottom-2 w-4 h-4 bg-gray-900/95 border-r border-b border-gray-700/50 transform rotate-45"
        >
        </div>
    </div>

    <!-- Hover Tooltip (preview only) -->
    <div
        id="calendar-tooltip"
        class="absolute hidden z-40 bg-gray-800 rounded-md shadow-lg px-3 py-2 text-xs text-gray-300 pointer-events-none"
        style="transform: translate(-50%, -100%); margin-top: -8px;"
    >
        <span id="tooltip-text"></span>
    </div>
</div>

<script is:inline>
    function initCalendar() {
        const container = document.getElementById("calendar-container");
        const popover = document.getElementById("calendar-popover");
        const popoverDateText = document.getElementById("popover-date-text");
        const popoverArticles = document.getElementById("popover-articles");
        const tooltip = document.getElementById("calendar-tooltip");
        const tooltipText = document.getElementById("tooltip-text");

        if (!container || !popover || !tooltip) return;

        let activeCell = null;

        const cells = container.querySelectorAll(".calendar-cell");

        cells.forEach((cell) => {
            const count = parseInt(cell.getAttribute("data-count") || "0", 10);
            if (count === 0) return;

            // Remove existing listeners to prevent duplicates
            const newCell = cell.cloneNode(true);
            cell.parentNode.replaceChild(newCell, cell);

            // Show simple tooltip on hover (desktop)
            newCell.addEventListener("mouseenter", function (e) {
                if (activeCell) return; // Don't show tooltip if popover is open
                const target = e.currentTarget;
                showTooltip(target);
            });

            newCell.addEventListener("mouseleave", function () {
                hideTooltip();
            });

            // Handle click to show popover with article links
            newCell.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                const target = e.currentTarget;

                // If clicking the same cell, close popover
                if (activeCell === target) {
                    hidePopover();
                    return;
                }

                showPopover(target);
            });

            // Touch support
            newCell.addEventListener(
                "touchend",
                function (e) {
                    e.preventDefault();
                    const target = e.currentTarget;

                    if (activeCell === target) {
                        hidePopover();
                        return;
                    }

                    showPopover(target);
                },
                { passive: false },
            );
        });

        // Close popover when clicking outside
        document.addEventListener("click", function (e) {
            if (
                !popover.contains(e.target) &&
                activeCell &&
                !activeCell.contains(e.target)
            ) {
                hidePopover();
            }
        });

        // Close popover on escape key
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
                hidePopover();
            }
        });

        function showTooltip(target) {
            const date = target.getAttribute("data-date");
            const count = target.getAttribute("data-count");

            if (tooltipText) {
                tooltipText.textContent = `${date} · ${count} 篇文章`;
            }

            tooltip.classList.remove("hidden");
            positionElement(tooltip, target, -8);
        }

        function hideTooltip() {
            tooltip.classList.add("hidden");
        }

        function showPopover(target) {
            hideTooltip();
            activeCell = target;

            // Highlight active cell
            target.classList.add("ring-2", "ring-blue-400");

            const date = target.getAttribute("data-date");
            const titlesStr = target.getAttribute("data-titles");
            const slugsStr = target.getAttribute("data-slugs");

            let titles = [];
            let slugs = [];
            try {
                titles = JSON.parse(titlesStr || "[]");
                slugs = JSON.parse(slugsStr || "[]");
            } catch (err) {
                titles = [];
                slugs = [];
            }

            if (popoverDateText) popoverDateText.textContent = date;

            if (popoverArticles) {
                popoverArticles.innerHTML = titles
                    .map(
                        (title, index) => `
                    <a 
                        href="/blog/${slugs[index]}/" 
                        class="block px-3 py-2 rounded-lg bg-gray-800/50 hover:bg-blue-600/20 border border-transparent hover:border-blue-500/30 transition-all duration-200 group"
                    >
                        <div class="text-sm font-medium text-blue-400 group-hover:text-blue-300 truncate">${title}</div>
                    </a>
                `,
                    )
                    .join("");
            }

            popover.classList.remove("hidden");
            positionElement(popover, target, -16);
        }

        function hidePopover() {
            popover.classList.add("hidden");
            if (activeCell) {
                activeCell.classList.remove("ring-2", "ring-blue-400");
                activeCell = null;
            }
        }

        function positionElement(element, target, marginTop) {
            const rect = target.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            let left = rect.left - containerRect.left + rect.width / 2;
            const top = rect.top - containerRect.top;

            // Adjust if popover would go off-screen
            const elementWidth = element.offsetWidth || 280;
            const minLeft = elementWidth / 2 + 10;
            const maxLeft = containerRect.width - elementWidth / 2 - 10;
            left = Math.max(minLeft, Math.min(maxLeft, left));

            element.style.left = left + "px";
            element.style.top = top + "px";
            element.style.marginTop = marginTop + "px";
        }
    }

    // Initialize on DOM ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCalendar);
    } else {
        initCalendar();
    }

    // Re-initialize after View Transitions (Astro page navigation)
    document.addEventListener("astro:after-swap", initCalendar);
    document.addEventListener("astro:page-load", initCalendar);
</script>
